<!doctype html>
<html>
	<head>
		<style>
			.message-bar {
				font-style: italic;
				font-weight: bolder;
			}
			.oneline {
				display: inline-flex;
				align-items: center;
			}
			.network-input {
				margin-left: 10px;
			}
			.network-ip {
				width: 100px;
			}
			.network-port {
				width: 40px;
			}
			.network .ng-invalid{
				border: 1px solid red;
			}
			input[type="radio"]:not(:checked)+label{ font-weight: lighter; }
		</style>
		<script type="text/javascript" src="/manager/webserver/assets/js/jquery.js"></script>
		<script type="text/javascript" src="/manager/webserver/assets/js/angular.js"></script>
		<script>
			angular.module('OtgSettingsApp', [])
			.controller('SettingsCtrl', ['$scope', function($scope) {
				$scope.foundOTG = false;
				$scope.messageActive = false;
				$scope.message = '';
				$scope.invalidIp = false;
				$scope.ip = '';
				$scope.port = '';
				$scope.features = { permanent: '1' };
				$scope.timeout;
				
				// Save the network configuration
				$scope.networkSave = function(form) {
					if (form.$valid) {
						console.log('>>networkSave');
						$scope.message = __('settings.search.title') + $scope.ip + ':' + $scope.port;
						$scope.messageActive = true;
						// Search for OTG
						Homey.api('PUT', '/search/', { 'ip': $scope.ip, 'port': $scope.port }, function(err, ok) {
							if (ok) {
								if ($scope.timeout) {
									clearTimeout($scope.timeout);
								}
								$scope.timeout = setTimeout(function(){ $scope.checkFound(form); }, 3000);
							}
						});
					}
				}
				
				$scope.checkFound = function(form) {
					Homey.api('GET', '/found/', {}, function (err, found) {
						$scope.foundOTG = found;
						console.log("Found state " + found);
						if ($scope.foundOTG) {
							console.log("Setting IP & port");
							Homey.set('ip', $scope.ip);
							Homey.set('port', $scope.port);
							$scope.message = __('settings.search.success');
						} else {
							console.log("Failure :-(");
							//$('#input').focus(); // set focus to first input field
							//form.$setValidity("network-ip", false);
							//form.$setValidity("network-port", false);
							$scope.message = __('settings.search.failed');
						}
						$scope.$apply();
					});
				}
				
				// Read the network configuration
				$scope.getNetworkConfig = function() {
					console.log("In getNetworkConfig");
					Homey.get('ip', function(err, ip) {
						console.log("Getting IP");
						if (err) { 
							return console.error('Could not get ip', err);
						}
						$scope.ip = ip;
						console.log(ip);
						$scope.$apply();
					});
					Homey.get('port', function(err, port) {
						if (err) { 
							return console.error('Could not get port', err);
						}
						$scope.port = port;
						$scope.$apply();
					});
				}
					
				// Save the features
				$scope.featureSave = function() {
					// Send the settings to the driver
					Homey.api('PUT', '/feature/', { 'features': $scope.features }, function(err, ok) {
						// Only save settings if driver validation is OK
						if (ok) {
							Homey.set('features', $scope.features);
						} else {
							console.log('Could not save feature settings ' + ok);
						}
					});
				};
				
				// Read the feature configuration
				$scope.getFeatureConfig = function() {
					Homey.get('features', function(err, value) {
						if (value) {
							$scope.features = value;
							$scope.$apply();
						}
					});
				}
				console.log("Retrieving network config");
				$scope.getNetworkConfig();
				$scope.getFeatureConfig();
			}]);

			function onHomeyReady(){
				angular.bootstrap(document, ['OtgSettingsApp']);
				Homey.ready();
			}
		</script>
	</head>

	<body ng-controller="SettingsCtrl">
		<fieldset ng-show="messageActive" style="background: #f8f8f8">
			<legend>Message</legend>
			<div class="message-bar">
				{{message}}
			</div>
		</fieldset>
		<div id="application">
			<h1 data-i18n="settings.app.title"></h1>
			<p data-i18n="settings.app.network.description"></p>
			<fieldset>
				<legend data-i18n="settings.app.network.title"></legend>
				<form name="networkForm" class="network" ng-class="{'submitted': submitted}" ng-submit="networkSave(networkForm)" >
					<div class="oneline"><label for="network-ip" data-i18n="settings.app.network.ip"></label><input class="network-input network-ip" ng-model="ip" placeholder="0.0.0.0" ng-pattern="/^([0-9]{1,3})[.]([0-9]{1,3})[.]([0-9]{1,3})[.]([0-9]{1,3})$/" required/></div>
					&nbsp;&nbsp;&nbsp;:
					<div class="oneline"><input class="network-input network-port" ng-model="port" placeholder="23" ng-pattern="/^\d+$/" required/></div>
					<p></p>
					<button type="submit" class="btn btn-default" ng-click="submitted=true;" data-i18n="settings.app.network.submit"></button>
				</form>
			</fieldset>
			<p data-i18n="settings.app.features.description"></p>
			<fieldset>
				<legend data-i18n="settings.app.features.title"></legend>
				<form ng-submit="featureSave()">
					<div class="oneline" data-i18n="settings.app.features.set"></div>
					<input type="radio" id="set-on" value="1" ng-model="features.permanent"><label for="set-on" data-i18n="settings.app.features.seton"></label>
					<input type="radio" id="set-off" value="0" ng-model="features.permanent"><label for="set-off" data-i18n="settings.app.features.setoff"></label>
					<p></p>
					<button type="submit" class="btn btn-default" ng-click="submitted=true;" data-i18n="settings.app.features.submit"></button>
				</form>
			</fieldset>
		</div>
		<p></p>
		<div id="gateway">
			<h1 data-i18n="settings.gateway.title"></h1>
			<fieldset>
				<legend data-i18n="settings.gateway.device.title"></legend>
			</fieldset>
		</div>
	</body>
</html>